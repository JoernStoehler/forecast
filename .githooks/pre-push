#!/usr/bin/env bash
# Heavier checks before pushing. Skippable with `--no-verify` or SKIP_HOOKS=1
set -euo pipefail

if [[ "${SKIP_HOOKS:-}" == "1" ]]; then
  echo "[hooks] pre-push skipped (SKIP_HOOKS=1)"
  exit 0
fi

echo "[hooks] pyright type-check"
uvx pyright -p pyrightconfig.json

echo "[hooks] pytest"
# Ensure Python dev dependencies (incl. pytest) are synced
uv sync --extra dev >/dev/null 2>&1 || uv sync --extra dev
uv run -m pytest -q

if [[ -f frontend/package.json ]]; then
  echo "[hooks] frontend type-check"
  pnpm --dir frontend typecheck
  echo "[hooks] frontend tests"
  pnpm --dir frontend test --silent
fi

echo "[hooks] OK"
